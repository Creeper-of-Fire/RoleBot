# RoleBot - Discord 身份组自助管理机器人

一个功能强大、配置灵活的 Discord 机器人，旨在为你的服务器提供现代化、用户友好的身份组自助服务体验。它完全基于斜杠命令和交互式组件。

## ✨ 主要功能

- **三种身份组模式**:
    - **⏱️ 限时高亮组**: 用户每天有固定的时长（例如：1小时）来佩戴特殊的、会改变昵称颜色的身份组。时间耗尽后，身份组将自动移除。
    - **🔧 自助身份组**: 用户可以随时通过面板自由领取或移除的普通身份组（目前UI只支持20个，因为我懒），非常适合用于频道权限、活动通知、身份标签等。
    - **👗 幻化衣橱**: 允许用户为其拥有的**基础身份组**佩戴一个或多个**幻化身份组**。幻化身份组通常层级更高，用于覆盖基础身份组的颜色，提供个性化外观。系统会智能判断你可用的幻化，并展示所有幻化选项（包括你未解锁的）。
- **现代化交互体验**:
    - **100% 斜杠命令**: 所有功能均通过 `/` 命令触发。
    - **私密管理面板**: 用户的所有操作都在一个只有自己可见的临时消息中完成，保护用户隐私，避免刷屏公共频道。
    - **实时反馈**: 每次点击按钮或选择身份组后，管理面板都会自动刷新，即时显示最新状态。
- **高度可配置**:
    - 在 `config_data.py` 文件中轻松配置所有参数。
    - 支持**多服务器**，每个服务器可以拥有自己独立的限时组、自助组和幻化配置。
    - 可自定义每日时长、重置时间、面板超时等。
- **自动化管理**:
    - 机器人自动在后台运行任务，每日定时重置用户时长、检查并移除过期限时身份组。
    - **新增：** 自动检查并移除用户因失去基础身份组而不再符合条件的幻化身份组。
- **数据持久化**:
    - 用户的限时组时长使用情况和当前状态会保存在本地，机器人重启后数据不会丢失。

## 📸 界面演示

1.  **公共入口面板**: 管理员使用 `/打开身份组自助中心面板` 命令在频道中发送一个公共面板。
     <!-- 假装这里有一个截图 -->

2.  **私有管理面板**: 用户点击 "管理我的身份组" 后，会收到一个只有自己能看到的、功能齐全的管理面板。
     <!-- 假装这里有一个截图 -->

3.  **幻化面板**: 用户点击 "幻化衣橱" 后，同样会收到一个私有的幻化管理面板，其中会显示所有幻化选项，并清晰标示哪些已解锁 (`✅`)，哪些需持有基础组 (`🔒`)。
     <!-- 假装这里有一个截图 -->

## 🚀 安装与配置指南

### 步骤 1: 克隆仓库并安装依赖

首先，确保你已经安装了 Python 3.8 或更高版本。

```bash
# 克隆项目到本地
git clone https://github.com/your-username/your-repo-name.git
cd your-repo-name

# (推荐) 创建并激活一个虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装所需的库
pip install -r requirements.txt
```

### 步骤 2: 获取必要 ID

在配置机器人之前，你需要获取一些 Discord 的 ID。

1.  **开启开发者模式**: 在 Discord 中，进入 `用户设置` > `高级` > 打开 `开发者模式`。
2.  **获取服务器 ID**: 在服务器列表上右键点击你的服务器图标，选择 `复制服务器 ID`。
3.  **获取身份组 ID**: 进入 `服务器设置` > `身份组`，右键点击你想要管理的身份组，选择 `复制 ID`。

### 步骤 3: 配置 `config_data.py`

这是最关键的一步。打开 `config_data.py` 文件并根据注释填写所有信息。

```python
# config_data.py

# 1. 填入你的机器人 Token
TOKEN = "在这里粘贴你的机器人Token"

# 2. 如果你需要通过代理连接 Discord，请填写代理地址
PROXY = None  # 例如: "http://127.0.0.1:7890"

# 3. 配置你的服务器 (GUILD_CONFIGS)
GUILD_CONFIGS = {
    # 将 1382335641735401584 替换为你的第一个服务器ID
    1382335641735401584: {
        # 限时身份组ID列表
        "timed_roles": [
            1387136946844864713,
            # 可以添加更多...
        ],
        # 自助身份组ID列表
        "self_service_roles": [
            1387136773267787776,
            # 可以添加更多...
        ]
    },
    # 如果你有第二个服务器，可以照着上面的格式继续添加
    # 987654321098765432: { ... }
}

# 4. 配置幻化系统 (FASHION_CONFIG)
FASHION_CONFIG = {
    # 替换为你的服务器ID
    1382335641735401584: {
        # "幻化幻化" 映射: { 基础身份组ID: [幻化身份组ID列表] }
        # 用户必须拥有 "基础身份组" 才能选择佩戴对应的 "幻化身份组"
        # 重要：在服务器设置中，"幻化身份组" 的层级必须高于 "基础身份组" 才能覆盖颜色！
        "fashion_map": {
            # 示例: 拥有基础组ID 111111111111111111 的用户，可以幻化为 222222222222222222 或 333333333333333333
            # 111111111111111111: [
            #     222222222222222222, 
            #     333333333333333333, 
            # ],
            # 另一个基础身份组映射
            # 444444444444444444: [
            #     555555555555555555,
            # ]
        }
    },
    # 可以继续添加更多服务器的幻化配置...
}
```

**重要提示**:
- 确保机器人在他要管理的服务器中，并且拥有 `管理身份组` 的权限。
- **权限层级至关重要**：确保机器人的身份组层级**高于**他需要管理的**所有**身份组（包括限时组、自助组和幻化组）。
- 对于幻化系统，**幻化身份组的层级必须高于其对应的基础身份组**，这样才能在用户佩戴幻化时，幻化身份组的颜色能够覆盖基础身份组的颜色。
- **速率限制**：为了避免触发 Discord 的 API 速率限制，机器人内部在批量处理用户（例如移除过期身份组或检查幻化合法性）时会引入短暂的延迟。如果你的服务器用户数量非常庞大（数万甚至数十万），你可能需要根据实际运行情况，在 `cog.py` 中的 `tasks.loop` 任务内部，适当增加 `asyncio.sleep()` 的延迟时间。

### 步骤 4: 运行机器人

一切准备就绪后，运行主程序。

```bash
python main.py
```

如果一切顺利，你会在控制台看到机器人成功登录的日志。

## 📖 使用方法

1.  **管理员**:
    - 在你希望用户能看到入口的频道中，使用命令 `/打开身份组自助中心面板`。机器人会发送一个包含几个按钮的公共面板。
2.  **普通用户**:
    - 点击公共面板上的 `⚙️ 管理我的身份组` 按钮。
    - 机器人会发送一条**只有该用户自己可见**的临时消息，其中包含完整的管理界面：
        - 在下拉菜单中选择或取消选择限时组。
        - 点击按钮来切换自助组的开关状态。
        - 点击 `⏱️ 查询我的时间` 可以查看今天限时组的剩余时长。
        - 点击 `↩️ 一键归还限时组` 可以立刻停止计时并移除当前佩戴的限时组。
    - 点击公共面板上的 `👗 幻化衣橱` 按钮。
    - 机器人会发送一条**只有该用户自己可见**的临时消息，其中包含幻化管理界面：
        - 下拉菜单中会显示所有配置的幻化身份组。
        - `✅` 标识的幻化表示你拥有对应基础身份组，可以佩戴。
        - `🔒` 标识的幻化表示你缺少对应基础身份组，暂时无法佩戴。
        - 选择或取消选择幻化身份组即可佩戴或卸下。

## 📂 项目结构

```
.
├── data/
│   └── user_data.json      # 存储用户数据
├── src/
│   └── role_manager/
│       ├── cog.py          # 核心业务逻辑，包括命令、UI组件和后台任务
│       └── data_manager.py # 数据读写与处理模块
├── bot.py                  # 机器人主入口，负责启动和加载模块
├── config.py               # 非敏感配置项
├── config_data.py          # 敏感配置项
├── requirements.txt        # Python 依赖库
└── README.md               # 就是你正在看的这个文件
```

## 💡 未来计划

- 无

## 🤝 贡献

欢迎提交 Pull Request 或创建 Issue 来为这个项目做出贡献！

## 📄 许可证

本项目采用 [MIT License](LICENSE) 开源。